services:
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite
    container_name: darkvelocity-azurite
    ports:
      - "10000:10000"  # Blob
      - "10001:10001"  # Queue
      - "10002:10002"  # Table
    volumes:
      - azurite_data:/data
    command: "azurite --blobHost 0.0.0.0 --queueHost 0.0.0.0 --tableHost 0.0.0.0 --location /data"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "10002"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres:
    image: postgres:16-alpine
    container_name: darkvelocity-postgres
    environment:
      POSTGRES_USER: darkvelocity
      POSTGRES_PASSWORD: darkvelocity_dev
      POSTGRES_DB: darkvelocity
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infrastructure/postgres/init-databases.sql:/docker-entrypoint-initdb.d/init-databases.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U darkvelocity"]
      interval: 5s
      timeout: 5s
      retries: 5

  spicedb:
    image: authzed/spicedb:latest
    container_name: darkvelocity-spicedb
    depends_on:
      postgres:
        condition: service_healthy
    command: serve
    ports:
      - "50051:50051"  # gRPC
      - "8443:8443"    # HTTP/REST gateway
      - "9090:9090"    # Metrics
    environment:
      SPICEDB_GRPC_PRESHARED_KEY: "darkvelocity_dev_key"
      SPICEDB_DATASTORE_ENGINE: postgres
      SPICEDB_DATASTORE_CONN_URI: "postgres://darkvelocity:darkvelocity_dev@postgres:5432/spicedb?sslmode=disable"
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:50051"]
      interval: 10s
      timeout: 5s
      retries: 5

  spicedb-migrate:
    image: authzed/spicedb:latest
    container_name: darkvelocity-spicedb-migrate
    depends_on:
      postgres:
        condition: service_healthy
    command: migrate head
    environment:
      SPICEDB_DATASTORE_ENGINE: postgres
      SPICEDB_DATASTORE_CONN_URI: "postgres://darkvelocity:darkvelocity_dev@postgres:5432/spicedb?sslmode=disable"

volumes:
  azurite_data:
  postgres_data:
